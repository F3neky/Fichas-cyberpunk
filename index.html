<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha Cyberpunk RED (v2.0 - Manual)</title>
    
    <style>
        /* GLOBAIS / RESET */
        :root {
            --cor-vermelha-principal: #AA0000;
            --cor-vermelha-escura: #770000;
            --cor-fundo-claro: #F5F5F5;
            --cor-fundo-escuro: #E0E0E0;
            --cor-borda: #333;
            --cor-texto: #111;
            --fonte-principal: 'Arial', sans-serif;
        }

        @page {
            size: A4;
            margin: 0.5cm;
        }

        body {
            font-family: var(--fonte-principal);
            background-color: #EEE;
            color: var(--cor-texto);
            line-height: 1.4;
            padding: 20px;
            margin: 0;
        }

        input, textarea, select {
            font-family: inherit;
            font-size: 1em;
            border: none;
            background-color: transparent;
            border-bottom: 1px dashed var(--cor-borda);
            padding: 2px 5px;
            box-sizing: border-box;
            color: var(--cor-texto);
        }

        textarea {
            resize: vertical;
            border: 1px solid var(--cor-borda);
            min-height: 50px;
            background-color: var(--cor-fundo-claro);
            padding: 5px;
        }

        label {
            font-size: 0.8em;
            font-weight: bold;
            display: block;
            color: #555;
            text-transform: uppercase;
        }

        /* ESTRUTURA PRINCIPAL */
        .sheet-container {
            display: flex;
            max-width: 1200px;
            margin: 20px auto;
            border: 5px solid var(--cor-vermelha-principal);
            background-color: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .main-content {
            flex-grow: 1;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }

        /* CONTROLES DE CABEÇALHO */
        .header-controls {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px 0;
            text-align: right;
        }

        .header-controls button, .header-controls .btn-import {
            background-color: var(--cor-vermelha-principal);
            color: white;
            border: none;
            padding: 8px 15px;
            cursor: pointer;
            margin-left: 5px;
            font-weight: bold;
            border-radius: 3px;
            text-transform: uppercase;
            font-size: 0.9em;
        }
        .header-controls button:hover, .header-controls .btn-import:hover {
            background-color: var(--cor-vermelha-escura);
        }

        /* GERENCIADOR DE FICHAS */
        #sheetManager {
            position: fixed;
            top: 50px;
            right: 50px;
            background: white;
            border: 2px solid var(--cor-vermelha-principal);
            padding: 15px;
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        #sheetList {
            margin-bottom: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .sheet-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            border-bottom: 1px dashed #DDD;
            cursor: pointer;
        }

        .sheet-item:hover, .sheet-item.active {
            background-color: var(--cor-fundo-claro);
        }

        .sheet-item .delete-btn {
            background: var(--cor-vermelha-escura);
            color: white;
            border: none;
            padding: 2px 6px;
            cursor: pointer;
            font-size: 0.7em;
        }

        /* STATS (BARRA LATERAL) */
        .stats-sidebar {
            width: 150px;
            background-color: var(--cor-vermelha-escura);
            padding: 5px;
            display: flex;
            flex-direction: column;
        }

        .stat-box {
            color: white;
            margin-bottom: 5px;
            padding: 5px;
            background-color: var(--cor-vermelha-principal);
            border: 1px solid white;
        }

        .stat-box label {
            font-size: 1.1em;
            color: white;
            text-align: center;
            margin-bottom: 2px;
        }

        .stat-box input {
            color: var(--cor-texto);
            background-color: var(--cor-fundo-claro);
            width: 100%;
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            border-bottom: none;
            padding: 5px 0;
        }

        /* INPUT GROUPS */
        .input-group {
            margin-bottom: 10px;
            border: 1px solid var(--cor-borda);
            padding: 5px;
        }

        .input-group label {
            margin-bottom: 3px;
            color: var(--cor-vermelha-principal);
            font-size: 0.7em;
        }

        .input-group input, .input-group textarea {
            width: 100%;
        }

        .input-group.full-width {
            grid-column: 1 / -1;
        }

        /* HEADER INFO */
        .header-info {
            display: flex;
            margin-bottom: 10px;
            gap: 10px;
        }

        .image-box {
            width: 200px;
            height: 300px;
            border: 3px solid var(--cor-vermelha-principal);
            background-color: var(--cor-fundo-escuro);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .image-label {
            display: block;
            width: 100%;
            height: 100%;
            text-align: center;
            cursor: pointer;
        }

        #characterImage {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #uploadText {
            color: #666;
            font-size: 0.9em;
            padding: 10px;
            display: block;
        }

        .text-info {
            flex-grow: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .text-info .input-group:nth-child(3) input {
            width: calc(100% - 70px);
            display: inline-block;
        }
        .text-info .input-group:nth-child(3) input[type="number"] {
            width: 60px;
            float: right;
            border-bottom: 1px dashed var(--cor-borda);
        }

        /* CALCULATED STATS (PV, HUMANIDADE) */
        .calculated-stats {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .humanidade-box, .hp-box, .crit-vicios-box {
            border: 2px solid var(--cor-vermelha-principal);
            padding: 5px;
            flex: 1;
            background-color: var(--cor-fundo-claro);
        }

        .humanidade-box label, .hp-box label {
            font-size: 1em;
            color: var(--cor-vermelha-escura);
        }

        .humanidade-box input, .hp-inputs input {
            font-size: 1.5em;
            font-weight: bold;
            width: 100%;
            text-align: center;
            border: none;
        }

        .hp-inputs {
            display: flex;
            align-items: baseline;
        }

        .hp-inputs input {
            flex: 1;
        }

        .max-label {
            font-size: 0.8em;
            font-weight: normal;
            color: #555;
            margin-left: 5px;
            white-space: nowrap;
        }

        .max-label input {
            font-size: 1em;
            width: 30px;
            text-align: left;
            display: inline;
        }

        .crit-vicios-box {
            flex-direction: column;
            display: flex;
        }
        .crit-vicios-box textarea {
            flex-grow: 1;
            min-height: 50px;
            border: none;
            padding: 0;
            margin-top: 2px;
        }
        .lesoes-criticas { flex: 1; }
        .vicios { flex: 1; margin-top: 5px; }

        /* GRAVEMENTE FERIDO BOX */
        .gravemente-ferido-box {
            display: flex;
            border: 2px solid var(--cor-vermelha-principal);
            margin-bottom: 10px;
            background-color: var(--cor-fundo-escuro);
        }

        .gf-status, .gf-penalidade, .teste-morte {
            padding: 5px 10px;
            border-right: 1px solid var(--cor-vermelha-principal);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .gf-status {
            flex: 1;
            min-width: 120px;
        }
        .gf-status label {
            font-size: 1em;
            color: var(--cor-vermelha-escura);
            margin-bottom: 5px;
        }
        .gf-status input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--cor-vermelha-principal);
            cursor: pointer;
            border: 1px solid var(--cor-borda);
            border-bottom: none;
        }
        #gf_limiar {
            font-size: 0.8em;
            color: #666;
            margin-top: 5px;
        }

        .gf-penalidade {
            flex: 2;
            font-size: 0.9em;
            font-weight: bold;
            color: var(--cor-vermelha-escura);
        }

        .teste-morte {
            flex: 1;
            border-right: none;
            min-width: 100px;
        }
        .teste-morte label {
            font-size: 0.9em;
            color: var(--cor-vermelha-escura);
        }
        .teste-morte input {
            font-size: 1.5em;
            font-weight: bold;
            width: 100%;
            text-align: center;
            border: none;
        }


        /* ABAS */
        .tabs {
            display: flex;
            margin-bottom: 5px;
        }

        .tab-link {
            background-color: var(--cor-fundo-escuro);
            border: 1px solid var(--cor-borda);
            border-bottom: none;
            padding: 8px 15px;
            cursor: pointer;
            font-weight: bold;
            margin-right: 3px;
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
        }

        .tab-link.active {
            background-color: white;
            border-bottom: 1px solid white; /* Cobre a borda de baixo */
        }

        .tab-content {
            border: 1px solid var(--cor-borda);
            padding: 10px;
            background-color: white;
            display: none;
            flex-grow: 1;
        }

        .tab-content.active {
            display: flex;
        }

        /* PERÍCIAS */
        .pericias-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .pericias-box {
            border: 1px solid var(--cor-borda);
            padding: 5px;
            background-color: var(--cor-fundo-claro);
        }

        .pericias-box.full-span {
            grid-column: 1 / -1;
        }

        .pericias-box h3 {
            margin: 0 0 5px 0;
            font-size: 1.1em;
            border-bottom: 2px solid var(--cor-vermelha-principal);
            padding-bottom: 3px;
            color: var(--cor-vermelha-escura);
        }

        .skill-list {
            display: flex;
            flex-direction: column;
        }

        .skill-header {
            display: grid;
            grid-template-columns: 3fr 1fr 1fr 1fr;
            font-weight: bold;
            font-size: 0.8em;
            text-align: center;
            border-bottom: 1px solid #AAA;
            padding-bottom: 3px;
            margin-bottom: 3px;
        }

        .skill-header span:first-child {
            text-align: left;
            padding-left: 5px;
        }

        .skill-item {
            display: grid;
            grid-template-columns: 3fr 1fr 1fr 1fr;
            gap: 5px;
            padding: 2px 0;
            align-items: center;
        }

        .skill-item:nth-child(even) {
            background-color: var(--cor-fundo-escuro);
        }

        .skill-name {
            padding-left: 5px;
            font-size: 0.9em;
        }

        .skill-name .stat-label {
            font-weight: normal;
            color: #666;
            font-size: 0.9em;
            display: inline;
        }

        .skill-item input {
            text-align: center;
            font-size: 1em;
            padding: 0;
            border-bottom: 1px dashed #AAA;
            background-color: transparent;
            width: 100%;
        }

        /* PERÍCIAS DINÂMICAS (IDIOMAS, ETC) */
        .dynamic-skill-box {
            margin-top: 10px;
            border: 1px solid #AAA;
            padding: 5px;
        }

        .dynamic-skill-box .skill-header {
            grid-template-columns: 3fr 1fr 1fr 1fr;
            padding-right: 40px; /* Espaço para o botão de deletar */
        }

        .dynamic-skill-item {
            display: grid;
            grid-template-columns: 3fr 1fr 1fr 1fr 40px; /* Nome, NVL, STAT, BASE, Del */
            gap: 5px;
            padding: 5px 0;
            align-items: center;
        }

        .dynamic-skill-item input {
            border: 1px dashed #AAA;
            text-align: center;
        }

        .dynamic-skill-item .skill-name-input { grid-column: 1 / 2; }
        .dynamic-skill-item .skill-nvl { grid-column: 2 / 3; }
        .dynamic-skill-item .skill-stat { grid-column: 3 / 4; }
        .dynamic-skill-item .skill-base { grid-column: 4 / 5; }

        .dynamic-skill-item .delete-row-btn {
            grid-column: 5 / 6;
            background: var(--cor-vermelha-escura);
            color: white;
            border: none;
            padding: 4px;
            font-size: 0.8em;
            cursor: pointer;
        }

        .add-row-btn {
            background-color: var(--cor-vermelha-principal);
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            margin-top: 5px;
            font-size: 0.9em;
            display: block;
            width: 100%;
            text-align: center;
        }
        .add-row-btn:hover {
            background-color: var(--cor-vermelha-escura);
        }


        /* INVENTÁRIO & ARMAS */
        .tab-content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .section-box {
            border: 1px solid var(--cor-borda);
            padding: 10px;
            background-color: var(--cor-fundo-claro);
        }

        .section-box h3 {
            margin: 0 0 10px 0;
            font-size: 1.1em;
            border-bottom: 2px solid var(--cor-vermelha-principal);
            padding-bottom: 3px;
            color: var(--cor-vermelha-escura);
            text-align: center;
        }

        .section-box.full-span {
            grid-column: 1 / -1;
        }

        .simple-box .input-group {
            border: none;
            padding: 0;
        }
        .simple-box .input-group input {
            border-bottom: 1px dashed var(--cor-vermelha-escura);
        }
        .simple-box .input-group label {
            font-size: 0.9em;
        }

        /* Armaduras */
        .armaduras-box {
            display: flex;
            flex-direction: column;
        }
        .armor-item {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 5px;
            padding: 5px 0;
            align-items: center;
        }
        .armor-header {
            font-weight: bold;
            text-align: center;
            border-bottom: 1px solid #AAA;
            margin-bottom: 5px;
        }
        .armor-item span {
            text-align: left;
            padding-left: 5px;
            font-weight: bold;
        }
        .armor-item input {
            text-align: center;
            border: 1px dashed #AAA;
        }
        .armaduras-box .small-text {
            font-size: 0.7em;
            text-align: center;
            margin-top: 10px;
            color: #555;
        }

        /* Armas */
        .arma-header {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 2fr 40px;
            font-weight: bold;
            text-align: center;
            border-bottom: 1px solid #AAA;
            padding-bottom: 3px;
            margin-bottom: 3px;
            font-size: 0.9em;
        }
        .arma-header span:first-child { text-align: left; padding-left: 5px;}

        .arma-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 2fr 40px;
            gap: 5px;
            padding: 3px 0;
            align-items: center;
        }
        .arma-item input {
            border: 1px dashed #AAA;
        }
        .arma-item .delete-row-btn {
            background: var(--cor-vermelha-escura);
            color: white;
            border: none;
            padding: 3px;
            font-size: 0.8em;
            cursor: pointer;
        }

        /* Equipamentos */
        .equip-header {
            display: grid;
            grid-template-columns: 3fr 1fr 3fr 40px;
            font-weight: bold;
            text-align: center;
            border-bottom: 1px solid #AAA;
            padding-bottom: 3px;
            margin-bottom: 3px;
            font-size: 0.9em;
        }
        .equip-header span:first-child { text-align: left; padding-left: 5px;}

        .equip-item {
            display: grid;
            grid-template-columns: 3fr 1fr 3fr 40px;
            gap: 5px;
            padding: 3px 0;
            align-items: center;
        }
        .equip-item input {
            border: 1px dashed #AAA;
        }
        .equip-item .delete-row-btn {
            background: var(--cor-vermelha-escura);
            color: white;
            border: none;
            padding: 3px;
            font-size: 0.8em;
            cursor: pointer;
        }


        /* CYBERWARE */
        .cyber-flex-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .cyber-list-box {
            border: 1px solid var(--cor-borda);
            padding: 5px;
            flex: 1 1 calc(50% - 10px); /* 2 por linha */
            min-width: 300px;
        }
        .cyber-list-box.full-span {
            flex: 1 1 100%;
        }

        .cyber-list-box h3 {
            margin: 0 0 5px 0;
            font-size: 1em;
            border-bottom: 1px solid var(--cor-vermelha-principal);
            padding-bottom: 3px;
            color: var(--cor-vermelha-escura);
            text-align: center;
        }

        .cyber-header {
            display: grid;
            grid-template-columns: 1fr 1fr 40px;
            font-weight: bold;
            text-align: center;
            border-bottom: 1px solid #AAA;
            padding-bottom: 3px;
            margin-bottom: 3px;
            font-size: 0.9em;
        }
        .cyber-header span:first-child { text-align: left; padding-left: 5px;}

        .cyber-list-box ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .cyber-item {
            display: grid;
            grid-template-columns: 1fr 1fr 40px;
            gap: 5px;
            padding: 3px 0;
            align-items: center;
        }
        .cyber-item input {
            border: 1px dashed #AAA;
        }
        .cyber-item .delete-row-btn {
            background: var(--cor-vermelha-escura);
            color: white;
            border: none;
            padding: 3px;
            font-size: 0.8em;
            cursor: pointer;
        }

        /* LIFEPATH */
        .lifepath-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .lifepath-grid .section-box:last-child {
            grid-column: 1 / -1;
        }

        .lifepath-grid .section-box .input-group {
            border: none;
            padding: 0;
            margin-bottom: 15px;
        }
        .lifepath-grid .section-box label {
            font-size: 0.9em;
            color: var(--cor-vermelha-escura);
        }
        .lifepath-grid .section-box textarea {
            min-height: 40px;
        }
        .lifepath-grid .section-box input[type="number"] {
            width: 100%;
            text-align: center;
            font-size: 1.2em;
            border: 1px dashed var(--cor-vermelha-escura);
        }

        /* PRINT MEDIA */
        @media print {
            body {
                background-color: white;
                padding: 0;
            }
            .header-controls, #sheetManager, .tabs, .add-row-btn, .delete-row-btn {
                display: none !important;
            }
            .sheet-container {
                border: none;
                box-shadow: none;
                margin: 0;
                max-width: none;
            }
            .main-content {
                /* Para garantir que o conteúdo preencha a página */
                height: 100vh;
            }
            .tab-content {
                display: flex !important;
                border: none;
                padding: 0;
                flex-grow: 1;
            }
            #pericias-tab {
                /* Garante que o grid de perícias fique visível e formatado */
                display: flex !important;
                flex-direction: column;
                page-break-after: always; /* Começa a próxima aba em nova página */
            }
            #pericias-tab .pericias-grid {
                flex-grow: 1;
            }
            #inventario-tab, #cyberware-tab, #lifepath-tab {
                 /* Para garantir que as abas não ativas apareçam */
                display: flex !important;
                page-break-after: always;
            }

            /* Corrige o input para aparecer o valor no print */
            input, textarea {
                color: var(--cor-texto) !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>
</head>
<body>
    <div id="sheetManager" style="display:none;">
        <h3>Gerenciar Fichas</h3>
        <div id="sheetList"></div>
        <button id="newSheet">Nova Ficha</button>
    </div>

    <div class="header-controls">
        <button id="manageSheets">Gerenciar Fichas</button>
        <button id="savePDF">Imprimir/Salvar PDF</button>
        <button id="exportJSON">Exportar JSON</button>
        <label for="importJSON" class="btn-import">Importar JSON</label>
        <input type="file" id="importJSON" accept=".json" style="display:none;">
    </div>

    <div class="sheet-container">
        <div class="stats-sidebar">
            <div class="stat-box">
                <label for="INT">INT</label>
                <input type="number" id="INT" value="0" min="0" max="10" data-stat data-save>
            </div>
            <div class="stat-box">
                <label for="REF">REF</label>
                <input type="number" id="REF" value="0" min="0" max="10" data-stat data-save>
            </div>
            <div class="stat-box">
                <label for="DES">DES</label>
                <input type="number" id="DES" value="0" min="0" max="10" data-stat data-save>
            </div>
            <div class="stat-box">
                <label for="TEC">TEC</label>
                <input type="number" id="TEC" value="0" min="0" max="10" data-stat data-save>
            </div>
            <div class="stat-box">
                <label for="MOR">MOR</label>
                <input type="number" id="MOR" value="0" min="0" max="10" data-stat data-save>
            </div>
            <div class="stat-box">
                <label for="VON">VON</label>
                <input type="number" id="VON" value="0" min="0" max="10" data-stat data-save>
            </div>
            <div class="stat-box">
                <label for="SORTE">SORTE</label>
                <input type="number" id="SORTE" value="0" min="0" max="10" data-stat data-save>
            </div>
            <div class="stat-box mov-box">
                <label for="MOV">MOV</label>
                <input type="number" id="MOV" value="0" min="0" max="10" data-stat data-save>
            </div>
            <div class="stat-box">
                <label for="CORPO">CORPO</label>
                <input type="number" id="CORPO" value="0" min="0" max="10" data-stat data-save>
            </div>
            <div class="stat-box">
                <label for="EMP_base">EMP (Base)</label>
                <input type="number" id="EMP_base" value="0" min="0" max="10" data-stat data-save>
            </div>
        </div>

        <div class="main-content">
            <div class="header-info">
                <div class="image-box">
                    <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                    <label for="imageUpload" class="image-label">
                        <img id="characterImage" src="" alt="Imagem do Personagem" style="display:none;">
                        <span id="uploadText">CLIQUE PARA ADICIONAR IMAGEM</span>
                    </label>
                </div>
                <div class="text-info">
                    <div class="input-group">
                        <label for="alcunha">ALCUNHA</label>
                        <input type="text" id="alcunha" data-save>
                    </div>
                    <div class="input-group">
                        <label for="cargo">CARGO</label>
                        <input type="text" id="cargo" data-save>
                    </div>
                    <div class="input-group">
                        <label for="habilidade_cargo">HABILIDADE DE CARGO</label>
                        <input type="text" id="habilidade_cargo" data-save>
                        <input type="number" id="graduacao" placeholder="Graduação" min="1" max="10" data-save>
                    </div>
                    <div class="input-group full-width">
                        <label for="observacoes_gerais">OBSERVAÇÕES</label>
                        <textarea id="observacoes_gerais" data-save></textarea>
                    </div>
                </div>
            </div>

            <div class="calculated-stats">
                <div class="humanidade-box">
                    <label for="humanidade_atual">HUMANIDADE</label>
                    <input type="number" id="humanidade_atual" placeholder="Atual" data-save>
                    <span class="max-label">MAX: <input type="number" id="humanidade_max" readonly></span>
                </div>
                <div class="hp-box">
                    <label>PONTOS DE VIDA</label>
                    <div class="hp-inputs">
                        <input type="number" id="pv_atual" placeholder="Atual" data-save>
                        <span class="max-label">MAX: <input type="number" id="pv_max" readonly></span>
                    </div>
                </div>
                <div class="crit-vicios-box">
                    <div class="lesoes-criticas">
                        <label for="lesoes_criticas">Lesões Críticas</label>
                        <textarea id="lesoes_criticas" data-save></textarea>
                    </div>
                    <div class="vicios">
                        <label for="vicios">Vícios</label>
                        <textarea id="vicios" data-save></textarea>
                    </div>
                </div>
            </div>
            
            <div class="gravemente-ferido-box">
                <div class="gf-status">
                    <label for="gf_checkbox">GRAVEMENTE FERIDO</label>
                    <input type="checkbox" id="gf_checkbox" data-save>
                    <span id="gf_limiar">(Limiar: 5)</span>
                </div>
                <div class="gf-penalidade">
                    -2 EM TODAS AS AÇÕES
                    <br>
                    QUANDO GRAVEMENTE FERIDO
                </div>
                <div class="teste-morte">
                    <label for="teste_morte">TESTE DE MORTE</label>
                    <input type="number" id="teste_morte" readonly>
                </div>
            </div>

            <div class="tabs">
                <button class="tab-link active" data-tab="pericias-tab">PERÍCIAS</button>
                <button class="tab-link" data-tab="inventario-tab">INVENTÁRIO & ARMAS</button>
                <button class="tab-link" data-tab="cyberware-tab">CIBERNÉTICOS</button>
                <button class="tab-link" data-tab="lifepath-tab">CAMINHO DE VIDA</button>
            </div>

            <div id="pericias-tab" class="tab-content active">
                <div class="pericias-grid">
                    <div class="pericias-box">
                        <h3>Perícias - Consciência</h3>
                        <div class="skill-header">
                            <span>Perícia (STAT)</span>
                            <span>NVL</span>
                            <span>STAT</span>
                            <span>BASE</span>
                        </div>
                        <div id="pericias-consciencia" class="skill-list">
                            </div>
                    </div>

                    <div class="pericias-box">
                        <h3>Perícias - Corporais</h3>
                        <div class="skill-header">
                            <span>Perícia (STAT)</span>
                            <span>NVL</span>
                            <span>STAT</span>
                            <span>BASE</span>
                        </div>
                        <div id="pericias-corporais" class="skill-list">
                            </div>
                    </div>

                    <div class="pericias-box">
                        <h3>Perícias - Controle</h3>
                        <div class="skill-header">
                            <span>Perícia (STAT)</span>
                            <span>NVL</span>
                            <span>STAT</span>
                            <span>BASE</span>
                        </div>
                        <div id="pericias-controle" class="skill-list">
                            </div>
                    </div>

                    <div class="pericias-box">
                        <h3>Perícias - Luta</h3>
                        <div class="skill-header">
                            <span>Perícia (STAT)</span>
                            <span>NVL</span>
                            <span>STAT</span>
                            <span>BASE</span>
                        </div>
                        <div id="pericias-luta" class="skill-list">
                            </div>
                    </div>

                    <div class="pericias-box">
                        <h3>Perícias - Armas de Longo Alcance</h3>
                        <div class="skill-header">
                            <span>Perícia (STAT)</span>
                            <span>NVL</span>
                            <span>STAT</span>
                            <span>BASE</span>
                        </div>
                        <div id="pericias-longoalcance" class="skill-list">
                            </div>
                    </div>

                    <div class="pericias-box full-span">
                        <h3>Perícias - Educacionais</h3>
                        <div class="skill-header">
                            <span>Perícia (STAT)</span>
                            <span>NVL</span>
                            <span>STAT</span>
                            <span>BASE</span>
                        </div>
                        <div id="pericias-educacionais" class="skill-list">
                            </div>
                    </div>
                    
                    <div class="pericias-box full-span">
                        <h3>Perícias - Sociais</h3>
                        <div class="skill-header">
                            <span>Perícia (STAT)</span>
                            <span>NVL</span>
                            <span>STAT</span>
                            <span>BASE</span>
                        </div>
                        <div id="pericias-sociais" class="skill-list">
                            </div>
                    </div>

                    <div class="pericias-box full-span">
                        <h3>Perícias - Técnicas</h3>
                        <div class="skill-header">
                            <span>Perícia (STAT)</span>
                            <span>NVL</span>
                            <span>STAT</span>
                            <span>BASE</span>
                        </div>
                        <div id="pericias-tecnicas" class="skill-list">
                            </div>
                    </div>
                    
                    <div class="pericias-box full-span">
                        <h3>Perícias Dinâmicas</h3>
                        
                        <div class="dynamic-skill-box">
                            <div class="dynamic-skill-list" id="idiomas-list">
                                <div class="skill-header">
                                    <span>Idiomas (INT)</span>
                                    <span>NVL</span>
                                    <span>STAT</span>
                                    <span>BASE</span>
                                </div>
                                </div>
                            <button class="add-row-btn" data-skill-type="idiomas">Adicionar Idioma</button>
                        </div>

                        <div class="dynamic-skill-box">
                            <div class="dynamic-skill-list" id="conhecimento-list">
                                <div class="skill-header">
                                    <span>Conhecimento de Área (INT)</span>
                                    <span>NVL</span>
                                    <span>STAT</span>
                                    <span>BASE</span>
                                </div>
                                </div>
                            <button class="add-row-btn" data-skill-type="conhecimento">Adicionar Conhec. Área</button>
                        </div>
                        
                        <div class="dynamic-skill-box">
                            <div class="dynamic-skill-list" id="ciencias-list">
                                <div class="skill-header">
                                    <span>Ciências (INT)</span>
                                    <span>NVL</span>
                                    <span>STAT</span>
                                    <span>BASE</span>
                                </div>
                                </div>
                            <button class="add-row-btn" data-skill-type="ciencias">Adicionar Ciência</button>
                        </div>
                    </div>

                </div>
            </div>

            <div id="inventario-tab" class="tab-content">
                <div class="tab-content-grid">
                    <div class="section-box simple-box">
                        <h3>MUNIÇÃO / DINHEIRO / MORADIA</h3>
                        <div class="input-group">
                            <label for="municao_geral">MUNIÇÃO (Geral)</label>
                            <input type="text" id="municao_geral" data-save>
                        </div>
                        <div class="input-group">
                            <label for="dinheiro">DINHEIRO</label>
                            <input type="text" id="dinheiro" data-save>
                        </div>
                        <div class="input-group">
                            <label for="habitacao">HABITAÇÃO</label>
                            <input type="text" id="habitacao" data-save>
                        </div>
                        <div class="input-group">
                            <label for="aluguel">ALUGUEL</label>
                            <input type="text" id="aluguel" data-save>
                        </div>
                        <div class="input-group">
                            <label for="estilo_vida">ESTILO DE VIDA</label>
                            <input type="text" id="estilo_vida" data-save>
                        </div>
                    </div>
                    
                    <div class="section-box armaduras-box">
                        <h3>ARMADURA</h3>
                        <div class="armor-item armor-header">
                            <span>PEÇA</span>
                            <span>PP</span>
                            <span>PENALIDADE</span>
                        </div>
                        <div class="armor-item">
                            <span>CABEÇA</span>
                            <input type="number" id="armadura_cabeca_pp" placeholder="PP" min="0" data-save>
                            <input type="number" id="armadura_cabeca_penalidade" placeholder="Penalidade" data-save>
                        </div>
                        <div class="armor-item">
                            <span>CORPO</span>
                            <input type="number" id="armadura_corpo_pp" placeholder="PP" min="0" data-save>
                            <input type="number" id="armadura_corpo_penalidade" placeholder="Penalidade" data-save>
                        </div>
                        <div class="armor-item">
                            <span>ESCUDO</span>
                            <input type="number" id="armadura_escudo_pp" placeholder="PP" min="0" data-save>
                            <input type="number" id="armadura_escudo_penalidade" placeholder="Penalidade" data-save>
                        </div>
                        <p class="small-text">A PENALIDADE SE APLICA A REF, DES & MOV</p>
                    </div>

                    <div class="section-box full-span armas-box">
                        <h3>ARMAS</h3>
                        <div class="arma-header">
                            <span>ARMA</span>
                            <span>DANO</span>
                            <span>MUNIÇÃO</span>
                            <span>CDT</span>
                            <span>OBS.</span>
                        </div>
                        <div id="armasList" class="list-container">
                            </div>
                        <button id="addArma" class="add-row-btn">Adicionar Arma</button>
                    </div>

                    <div class="section-box full-span equipamento-box">
                        <h3>EQUIPAMENTO</h3>
                        <div class="equip-header">
                            <span>ITEM</span>
                            <span>QTD</span>
                            <span>NOTAS</span>
                        </div>
                        <div id="equipamentoList" class="list-container">
                            </div>
                        <button id="addEquipamento" class="add-row-btn">Adicionar Equipamento</button>
                    </div>
                </div>
            </div>

            <div id="cyberware-tab" class="tab-content">
                <div class="cyber-flex-container">
                    <div class="cyber-list-box">
                        <h3>PACOTE DE CIBERAUDIO</h3>
                        <div class="cyber-header">
                            <span>NOME</span>
                            <span>INFO/CUSTO</span>
                        </div>
                        <ul id="cyber-audio-list"></ul>
                        <button class="add-row-btn" data-cyber-type="audio">Adicionar Peça de Áudio</button>
                    </div>
                    
                    <div class="cyber-list-box">
                        <h3>CIBEROLHO DIREITO</h3>
                        <div class="cyber-header">
                            <span>NOME</span>
                            <span>INFO/CUSTO</span>
                        </div>
                        <ul id="cyber-olho-direito-list"></ul>
                        <button class="add-row-btn" data-cyber-type="olho-direito">Adicionar Peça de Olho</button>
                    </div>

                    <div class="cyber-list-box">
                        <h3>CIBEROLHO ESQUERDO</h3>
                        <div class="cyber-header">
                            <span>NOME</span>
                            <span>INFO/CUSTO</span>
                        </div>
                        <ul id="cyber-olho-esquerdo-list"></ul>
                        <button class="add-row-btn" data-cyber-type="olho-esquerdo">Adicionar Peça de Olho</button>
                    </div>

                    <div class="cyber-list-box">
                        <h3>CIBERBRAÇO DIREITO</h3>
                        <div class="cyber-header">
                            <span>NOME</span>
                            <span>INFO/CUSTO</span>
                        </div>
                        <ul id="cyber-braco-direito-list"></ul>
                        <button class="add-row-btn" data-cyber-type="braco-direito">Adicionar Peça de Braço</button>
                    </div>

                    <div class="cyber-list-box">
                        <h3>CIBERBRAÇO ESQUERDO</h3>
                        <div class="cyber-header">
                            <span>NOME</span>
                            <span>INFO/CUSTO</span>
                        </div>
                        <ul id="cyber-braco-esquerdo-list"></ul>
                        <button class="add-row-btn" data-cyber-type="braco-esquerdo">Adicionar Peça de Braço</button>
                    </div>

                    <div class="cyber-list-box">
                        <h3>CIBERPERNA DIREITA</h3>
                        <div class="cyber-header">
                            <span>NOME</span>
                            <span>INFO/CUSTO</span>
                        </div>
                        <ul id="cyber-perna-direita-list"></ul>
                        <button class="add-row-btn" data-cyber-type="perna-direita">Adicionar Peça de Perna</button>
                    </div>

                    <div class="cyber-list-box">
                        <h3>CIBERPERNA ESQUERDA</h3>
                        <div class="cyber-header">
                            <span>NOME</span>
                            <span>INFO/CUSTO</span>
                        </div>
                        <ul id="cyber-perna-esquerda-list"></ul>
                        <button class="add-row-btn" data-cyber-type="perna-esquerda">Adicionar Peça de Perna</button>
                    </div>
                    
                    <div class="cyber-list-box">
                        <h3>LINK NEURAL</h3>
                        <div class="cyber-header">
                            <span>NOME</span>
                            <span>INFO/CUSTO</span>
                        </div>
                        <ul id="cyber-neural-list"></ul>
                        <button class="add-row-btn" data-cyber-type="neural">Adicionar Peça Neural</button>
                    </div>

                    <div class="cyber-list-box full-span">
                        <h3>CIBERNÉTICOS INTERNOS</h3>
                        <div class="cyber-header">
                            <span>NOME</span>
                            <span>INFO/CUSTO</span>
                        </div>
                        <ul id="cyber-interno-list"></ul>
                        <button class="add-row-btn" data-cyber-type="interno">Adicionar Cyberware Interno</button>
                    </div>

                    <div class="cyber-list-box full-span">
                        <h3>CIBERNÉTICOS EXTERNOS</h3>
                        <div class="cyber-header">
                            <span>NOME</span>
                            <span>INFO/CUSTO</span>
                        </div>
                        <ul id="cyber-externo-list"></ul>
                        <button class="add-row-btn" data-cyber-type="externo">Adicionar Cyberware Externo</button>
                    </div>
                    
                    <div class="cyber-list-box full-span">
                        <h3>EQUIPAMENTO DE MODA</h3>
                        <div class="cyber-header">
                            <span>NOME</span>
                            <span>INFO/CUSTO</span>
                        </div>
                        <ul id="cyber-moda-list"></ul>
                        <button class="add-row-btn" data-cyber-type="moda">Adicionar Cyberware de Moda</button>
                    </div>
                    
                    <div class="cyber-list-box full-span">
                        <h3>EQUIPAMENTO BORGUE</h3>
                        <div class="cyber-header">
                            <span>NOME</span>
                            <span>INFO/CUSTO</span>
                        </div>
                        <ul id="cyber-borgue-list"></ul>
                        <button class="add-row-btn" data-cyber-type="borgue">Adicionar Cyberware Borgue</button>
                    </div>
                </div>
            </div>

            <div id="lifepath-tab" class="tab-content">
                <div class="lifepath-grid">
                    <div class="section-box">
                        <h3>CAMINHO DE VIDA</h3>
                        <div class="input-group">
                            <label for="origem_cultural">ORIGEM CULTURAL</label>
                            <textarea id="origem_cultural" data-save></textarea>
                        </div>
                        <div class="input-group">
                            <label for="personalidade">PERSONALIDADE</label>
                            <textarea id="personalidade" data-save></textarea>
                        </div>
                        <div class="input-group">
                            <label for="estilo_vestimenta">ESTILO DE VESTIMENTA</label>
                            <textarea id="estilo_vestimenta" data-save></textarea>
                        </div>
                        <div class="input-group">
                            <label for="estilo_cabelo">ESTILO DE CABELO</label>
                            <textarea id="estilo_cabelo" data-save></textarea>
                        </div>
                        <div class="input-group">
                            <label for="valoriza">O QUE VOCÊ MAIS VALORIZA?</label>
                            <textarea id="valoriza" data-save></textarea>
                        </div>
                        <div class="input-group">
                            <label for="relacao_pessoas">COMO SE SENTE EM RELAÇÃO ÀS PESSOAS?</label>
                            <textarea id="relacao_pessoas" data-save></textarea>
                        </div>
                        <div class="input-group">
                            <label for="pessoa_valoriza">PESSOA QUE VOCÊ MAIS VALORIZA</label>
                            <textarea id="pessoa_valoriza" data-save></textarea>
                        </div>
                        <div class="input-group">
                            <label for="posse_valiosa">POSSE MAIS VALIOSA</label>
                            <textarea id="posse_valiosa" data-save></textarea>
                        </div>
                        <div class="input-group">
                            <label for="origem_familiar">ORIGEM FAMILIAR</label>
                            <textarea id="origem_familiar" data-save></textarea>
                        </div>
                        <div class="input-group">
                            <label for="crise_familiar">CRISE FAMILIAR</label>
                            <textarea id="crise_familiar" data-save></textarea>
                        </div>
                        <div class="input-group">
                            <label for="amigos">AMIGOS</label>
                            <textarea id="amigos" data-save></textarea>
                        </div>
                        <div class="input-group">
                            <label for="situacao_criacao">SITUAÇÃO DE CRIAÇÃO</label>
                            <textarea id="situacao_criacao" data-save></textarea>
                        </div>
                        <div class="input-group">
                            <label for="objetivos_vida">OBJETIVOS DE VIDA</label>
                            <textarea id="objetivos_vida" data-save></textarea>
                        </div>
                        <div class="input-group">
                            <label for="pseudonimos">PSEUDÔNIMOS</label>
                            <textarea id="pseudonimos" data-save></textarea>
                        </div>
                        <div class="input-group">
                            <label for="historias_amor">HISTÓRIAS DE AMOR TRÁGICAS</label>
                            <textarea id="historias_amor" data-save></textarea>
                        </div>
                        <div class="input-group">
                            <label for="moda">MODA</label>
                            <textarea id="moda" data-save></textarea>
                        </div>
                        <div class="input-group">
                            <label for="caminho_cargo">CAMINHO DE VIDA DE CARGO</label>
                            <textarea id="caminho_cargo" data-save></textarea>
                        </div>
                    </div>
                    
                    <div class="section-box">
                        <h3>REPUTAÇÃO / PONTOS DE MELHORIA</h3>
                        <div class="input-group">
                            <label for="reputacao">REPUTAÇÃO</label>
                            <input type="number" id="reputacao" min="0" data-save>
                        </div>
                        <div class="input-group">
                            <label for="pontos_melhoria">PONTOS DE MELHORIA</label>
                            <input type="number" id="pontos_melhoria" min="0" data-save>
                        </div>
                        <div class="input-group">
                            <label for="eventos_reputacao">EVENTOS DE REPUTAÇÃO</label>
                            <textarea id="eventos_reputacao" data-save></textarea>
                        </div>
                        <div class="input-group full-width">
                            <label for="observacoes_lifepath">OBSERVAÇÕES (LIFEPATH)</label>
                            <textarea id="observacoes_lifepath" data-save></textarea>
                        </div>
                    </div>

                    <div class="section-box full-span inimigos-box">
                        <h3>INIMIGOS</h3>
                        <div class="input-group">
                            <label for="inimigo_quem">Quem?</label>
                            <textarea id="inimigo_quem" data-save></textarea>
                        </div>
                        <div class="input-group">
                            <label for="inimigo_causa">O Que Causou?</label>
                            <textarea id="inimigo_causa" data-save></textarea>
                        </div>
                        <div class="input-group">
                            <label for="inimigo_podem_fazer">O Que Podem Fazer Contra Você?</label>
                            <textarea id="inimigo_podem_fazer" data-save></textarea>
                        </div>
                        <div class="input-group">
                            <label for="inimigo_vai_acontecer">O Que Vai Acontecer?</label>
                            <textarea id="inimigo_vai_acontecer" data-save></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            let currentSheetId = localStorage.getItem('cyberpunkRedCurrentSheet') || 'ficha-0';
            let sheets = JSON.parse(localStorage.getItem('cyberpunkRedSheets')) || {};
            if (Object.keys(sheets).length === 0) {
                sheets['ficha-0'] = { 'alcunha': 'Nova Ficha' };
            }

            // --- DEFINIÇÃO DE PERÍCIAS (Baseado no PDF) ---
            const pdfPericias = {
                consciencia: [
                    { nome: 'Concentração', stat: 'VON' },
                    { nome: 'Leitura Labial', stat: 'INT' },
                    { nome: 'Ocultar/Revelar Objeto', stat: 'INT' },
                    { nome: 'Percepção', stat: 'INT' },
                    { nome: 'Rastreamento', stat: 'INT' }
                ],
                corporais: [
                    { nome: 'Atletismo', stat: 'DES' },
                    { nome: 'Contorcionismo', stat: 'DES' },
                    { nome: 'Dança', stat: 'DES' },
                    { nome: 'Furtividade', stat: 'DES' },
                    { nome: 'Resistência', stat: 'VON' },
                    { nome: 'Resistir à Tortura/Drogas', stat: 'VON' }
                ],
                controle: [
                    { nome: 'Condutor de Veículo Terrestre', stat: 'REF' },
                    { nome: 'Montaria', stat: 'REF' },
                    { nome: 'Piloto de Veículo Aéreo (x2)', stat: 'REF' },
                    { nome: 'Piloto de Veículo Marítimo', stat: 'REF' }
                ],
                educacionais: [
                    { nome: 'Burocracia', stat: 'INT' },
                    { nome: 'Contabilidade', stat: 'INT' },
                    { nome: 'Criação', stat: 'INT' },
                    { nome: 'Criminologia', stat: 'INT' },
                    { nome: 'Criptografia', stat: 'INT' },
                    { nome: 'Dedução', stat: 'INT' },
                    { nome: 'Educação', stat: 'INT' },
                    { nome: 'Jogos de Azar', stat: 'INT' },
                    { nome: 'Negócios', stat: 'INT' },
                    { nome: 'Trato com Animais', stat: 'INT' },
                    { nome: 'Biblioteconomia', stat: 'INT' },
                    { nome: 'Sobrevivência na Natureza', stat: 'INT' },
                    { nome: 'Táticas', stat: 'INT' }
                ],
                luta: [
                    { nome: 'Armas Brancas', stat: 'DES' },
                    { nome: 'Artes Marciais', stat: 'DES' },
                    { nome: 'Briga', stat: 'DES' },
                    { nome: 'Evasão', stat: 'DES' }
                ],
                longoalcance: [
                    { nome: 'Armas Pesadas (x2)', stat: 'REF' },
                    { nome: 'Armas de Ombro', stat: 'REF' },
                    { nome: 'Arquearia', stat: 'REF' },
                    { nome: 'Armas de Mão', stat: 'REF' },
                    { nome: 'Fogo Automático (x2)', stat: 'REF' }
                ],
                sociais: [
                    { nome: 'Comércio', stat: 'MOR' },
                    { nome: 'Conversação', stat: 'EMP' },
                    { nome: 'Cuidados Pessoais', stat: 'MOR' },
                    { nome: 'Interrogação', stat: 'MOR' },
                    { nome: 'Manha', stat: 'MOR' },
                    { nome: 'Percepção Humana', stat: 'EMP' },
                    { nome: 'Persuasão', stat: 'MOR' },
                    { nome: 'Suborno', stat: 'MOR' },
                    { nome: 'Vestimenta & Estilo', stat: 'MOR' }
                ],
                tecnicas: [
                    { nome: 'Abrir Fechadura', stat: 'TEC' },
                    { nome: 'Cibertecnologia', stat: 'TEC' },
                    { nome: 'Demolição (x2)', stat: 'TEC' },
                    { nome: 'Falsificação', stat: 'TEC' },
                    { nome: 'Fotografia/Filmagem', stat: 'TEC' },
                    { nome: 'Paramédico (x2)', stat: 'TEC' },
                    { nome: 'Pintar/Desenhar/Esculpir', stat: 'TEC' },
                    { nome: 'Primeiros Socorros', stat: 'TEC' },
                    { nome: 'Punga', stat: 'TEC' },
                    { nome: 'Tecnologia Básica', stat: 'TEC' },
                    { nome: 'Tecnologia de Armas', stat: 'TEC' },
                    { nome: 'Tecnologia de Veículos Aéreas', stat: 'TEC' },
                    { nome: 'Tecnologia de Veículos Marítimos', stat: 'TEC' },
                    { nome: 'Tecnologia de Veículos Terrestres', stat: 'TEC' },
                    { nome: 'Tecnologia Eletrônica de Segurança (x2)', stat: 'TEC' }
                ]
            };

            // --- INICIALIZAÇÃO ---
            function init() {
                // Abas
                document.querySelectorAll('.tab-link').forEach(button => {
                    button.addEventListener('click', () => switchTab(button.dataset.tab));
                });

                // Controles da Ficha
                document.getElementById('manageSheets').addEventListener('click', toggleSheetManager);
                document.getElementById('newSheet').addEventListener('click', newSheet);
                document.getElementById('savePDF').addEventListener('click', () => window.print());
                document.getElementById('exportJSON').addEventListener('click', exportSheet);
                document.getElementById('importJSON').addEventListener('change', importSheet);

                // Imagem
                document.getElementById('imageUpload').addEventListener('change', loadImage);

                // Listeners para Salvar e Calcular (APENAS HP/HUMANIDADE)
                document.querySelectorAll('[data-save]').forEach(el => {
                    el.addEventListener('input', autoSave);
                });
                document.querySelectorAll('[data-stat]').forEach(el => {
                    el.addEventListener('input', () => {
                        updateAllCalculatedStats(); // Atualiza HP, etc.
                        autoSave(); // Salva a mudança no stat
                    });
                });

                // Botões de Adicionar
                document.getElementById('addArma').addEventListener('click', () => addArma());
                document.getElementById('addEquipamento').addEventListener('click', () => addEquipamento());
                document.querySelectorAll('.add-row-btn[data-skill-type]').forEach(btn => {
                    btn.addEventListener('click', () => addDynamicSkillRow(btn.dataset.skillType));
                });
                document.querySelectorAll('.add-row-btn[data-cyber-type]').forEach(btn => {
                    btn.addEventListener('click', () => addCyberItem(btn.dataset.cyberType));
                });

                renderAllPericias();
                loadFormData(getSavedData());
                renderSheetList();
                updateAllCalculatedStats();
            }

            // --- SISTEMA DE ABAS ---
            function switchTab(tabId) {
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.querySelectorAll('.tab-link').forEach(link => link.classList.remove('active'));
                document.getElementById(tabId).classList.add('active');
                document.querySelector(`.tab-link[data-tab="${tabId}"]`).classList.add('active');
            }

            // --- GERENCIAMENTO DE FICHAS (Salvar, Carregar, Múltiplas Fichas) ---
            function getSavedData() {
                return sheets[currentSheetId] || {};
            }

            function autoSave() {
                sheets[currentSheetId] = getFormData();
                localStorage.setItem('cyberpunkRedSheets', JSON.stringify(sheets));
                localStorage.setItem('cyberpunkRedCurrentSheet', currentSheetId);
                // Atualiza o nome na lista
                const activeItem = document.querySelector(`#sheetList .sheet-item[data-id="${currentSheetId}"] span`);
                if (activeItem) {
                    activeItem.textContent = sheets[currentSheetId].alcunha || 'Ficha Sem Nome';
                }
            }

            function getFormData() {
                const data = {
                    dynamicSkills: {},
                    armas: [],
                    equipamentos: [],
                    cyberware: {}
                };

                // Campos simples (Inputs e Textareas)
                document.querySelectorAll('[data-save]').forEach(el => {
                    // Verifica se o elemento tem um ID
                    if (el.id) {
                        // Para números estáticos, armazena como número, senão como string
                        data[el.id] = el.type === 'number' ? (parseInt(el.value) || 0) : el.value;
                    }
                });
                
                // Checkboxes
                document.querySelectorAll('input[type="checkbox"][data-save]').forEach(el => {
                    data[el.id] = el.checked;
                });

                // Imagem
                data.characterImage = document.getElementById('characterImage').src;

                // Perícias Dinâmicas (Idiomas, etc.)
                document.querySelectorAll('.dynamic-skill-list').forEach(list => {
                    const type = list.id.replace('-list', '');
                    data.dynamicSkills[type] = [];
                    list.querySelectorAll('.dynamic-skill-item').forEach(item => {
                        data.dynamicSkills[type].push({
                            id: item.dataset.id,
                            nome: item.querySelector('.skill-name-input').value,
                            nvl: item.querySelector('.skill-nvl').value,
                            stat: item.querySelector('.skill-stat').value, 
                            base: item.querySelector('.skill-base').value  
                        });
                    });
                });
                
                // Armas
                document.querySelectorAll('#armasList .arma-item').forEach(item => {
                    data.armas.push({
                        id: item.dataset.id,
                        nome: item.querySelector('.arma-nome').value,
                        dano: item.querySelector('.arma-dano').value,
                        municao: item.querySelector('.arma-municao').value,
                        cdt: item.querySelector('.arma-cdt').value,
                        obs: item.querySelector('.arma-obs').value,
                    });
                });
                
                // Equipamentos
                document.querySelectorAll('#equipamentoList .equip-item').forEach(item => {
                    data.equipamentos.push({
                        id: item.dataset.id,
                        nome: item.querySelector('.equip-nome').value,
                        qtd: item.querySelector('.equip-qtd').value,
                        obs: item.querySelector('.equip-obs').value,
                    });
                });

                // Cyberware
                document.querySelectorAll('.cyber-list-box').forEach(box => {
                    // Encontra o tipo a partir do ID da lista UL (Ex: cyber-audio-list -> audio)
                    const typeList = box.querySelector('ul[id^="cyber-"]');
                    if (!typeList) return; 

                    const type = typeList.id.split('-')[1] || typeList.id.split('-')[2]; // 'audio' ou 'olho-direito'
                    
                    data.cyberware[type] = [];
                    typeList.querySelectorAll('.cyber-item').forEach(item => {
                        data.cyberware[type].push({
                            id: item.dataset.id,
                            nome: item.querySelector('.cyber-nome').value,
                            info: item.querySelector('.cyber-info').value
                        });
                    });
                });


                return data;
            }

            function loadFormData(data) {
                // Limpa campos antes de carregar
                document.querySelectorAll('[data-save]').forEach(el => {
                    if (el.type === 'checkbox') {
                         el.checked = false;
                    } else {
                         el.value = el.type === 'number' ? 0 : '';
                    }
                });
                
                // Recria as perícias estáticas para garantir que os campos de input existam
                renderAllPericias(); 
                
                // Limpa listas dinâmicas
                document.querySelectorAll('.dynamic-skill-list').forEach(list => {
                    const header = list.querySelector('.skill-header');
                    list.innerHTML = '';
                    if(header) list.appendChild(header);
                });
                document.getElementById('armasList').innerHTML = '';
                document.getElementById('equipamentoList').innerHTML = '';
                document.querySelectorAll('.cyber-list-box ul').forEach(list => list.innerHTML = '';);
                
                // Carrega campos simples
                for (const key in data) {
                    const el = document.getElementById(key);
                    if (el && el.hasAttribute('data-save')) {
                        if (el.type === 'checkbox') {
                            el.checked = data[key] === true;
                        } else {
                            el.value = data[key];
                        }
                    }
                }

                // Imagem
                const imgEl = document.getElementById('characterImage');
                const uploadTextEl = document.getElementById('uploadText');
                if (data.characterImage && data.characterImage.startsWith('data:image')) {
                    imgEl.src = data.characterImage;
                    imgEl.style.display = 'block';
                    uploadTextEl.style.display = 'none';
                } else {
                    imgEl.src = '';
                    imgEl.style.display = 'none';
                    uploadTextEl.style.display = 'block';
                }

                // Perícias Dinâmicas
                if (data.dynamicSkills) {
                    for (const type in data.dynamicSkills) {
                        // Garante que o header exista (se for uma lista dinâmicas)
                        let list = document.getElementById(`${type}-list`);
                        if(list && !list.querySelector('.skill-header')) {
                            // Recria o header se necessário (embora o HTML já deva ter)
                            const header = document.createElement('div');
                            header.className = 'skill-header';
                            let label = type === 'idiomas' ? 'Idiomas (INT)' : 
                                        type === 'conhecimento' ? 'Conhecimento de Área (INT)' :
                                        type === 'ciencias' ? 'Ciências (INT)' : 'Perícia';
                            header.innerHTML = `<span>${label}</span><span>NVL</span><span>STAT</span><span>BASE</span>`;
                            list.prepend(header);
                        }
                        
                        if (Array.isArray(data.dynamicSkills[type])) {
                            data.dynamicSkills[type].forEach(skill => {
                                addDynamicSkillRow(type, skill);
                            });
                        }
                    }
                }
                
                // Armas
                if(data.armas && Array.isArray(data.armas)) {
                    data.armas.forEach(arma => addArma(arma));
                }
                
                // Equipamentos
                if(data.equipamentos && Array.isArray(data.equipamentos)) {
                    data.equipamentos.forEach(equip => addEquipamento(equip));
                }

                // Cyberware
                if(data.cyberware) {
                    for (const type in data.cyberware) {
                        if (Array.isArray(data.cyberware[type])) {
                            data.cyberware[type].forEach(item => addCyberItem(type, item));
                        }
                    }
                }

                updateAllCalculatedStats();
            }

            function toggleSheetManager() {
                const manager = document.getElementById('sheetManager');
                manager.style.display = manager.style.display === 'none' ? 'block' : 'none';
            }

            function renderSheetList() {
                const list = document.getElementById('sheetList');
                list.innerHTML = '';
                for (const id in sheets) {
                    const name = sheets[id].alcunha || `Ficha ${id}`;
                    const item = document.createElement('div');
                    item.className = 'sheet-item' + (id === currentSheetId ? ' active' : '');
                    item.dataset.id = id;
                    item.innerHTML = `
                        <span class="sheet-name">${name}</span>
                        <button class="delete-btn" data-id="${id}">X</button>
                    `;
                    item.querySelector('.sheet-name').addEventListener('click', () => switchSheet(id));
                    item.querySelector('.delete-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteSheet(id);
                    });
                    list.appendChild(item);
                }
            }

            function switchSheet(id) {
                if (id === currentSheetId) return;
                autoSave(); // Salva a ficha atual
                currentSheetId = id;
                localStorage.setItem('cyberpunkRedCurrentSheet', currentSheetId);
                loadFormData(getSavedData()); // Carrega a nova ficha
                renderSheetList();
                toggleSheetManager();
            }

            function newSheet() {
                const newName = prompt('Digite a alcunha do novo personagem:');
                if (!newName) return;
                
                autoSave(); // Salva a ficha atual
                const newId = 'ficha-' + Date.now();
                currentSheetId = newId;
                sheets[newId] = { alcunha: newName };
                localStorage.setItem('cyberpunkRedCurrentSheet', currentSheetId);
                localStorage.setItem('cyberpunkRedSheets', JSON.stringify(sheets));
                
                loadFormData(getSavedData()); // Carrega a nova ficha (vazia)
                renderSheetList();
                updateAllCalculatedStats();
            }

            function deleteSheet(id) {
                if (Object.keys(sheets).length <= 1) {
                    alert('Você deve ter pelo menos uma ficha.');
                    return;
                }
                if (confirm(`Tem certeza que quer deletar a ficha "${sheets[id].alcunha || 'Sem Nome'}"?`)) {
                    delete sheets[id];
                    if (currentSheetId === id) {
                        currentSheetId = Object.keys(sheets)[0]; // Muda para a primeira ficha
                    }
                    localStorage.setItem('cyberpunkRedSheets', JSON.stringify(sheets));
                    localStorage.setItem('cyberpunkRedCurrentSheet', currentSheetId);
                    loadFormData(getSavedData());
                    renderSheetList();
                }
            }
            
            // --- IMPORTAR / EXPORTAR ---
            function exportSheet() {
                autoSave();
                const data = JSON.stringify(getFormData(), null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const fileName = (getFormData().alcunha || 'ficha_cyberpunk').replace(/\s/g, '_');
                a.href = url;
                a.download = `${fileName}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }

            function importSheet(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        // Gera novo ID para a ficha importada
                        const newId = 'ficha-' + Date.now();
                        sheets[newId] = data;
                        currentSheetId = newId;
                        
                        localStorage.setItem('cyberpunkRedSheets', JSON.stringify(sheets));
                        localStorage.setItem('cyberpunkRedCurrentSheet', currentSheetId);
                        
                        loadFormData(data);
                        renderSheetList();
                        alert(`Ficha "${data.alcunha || 'Importada'}" carregada com sucesso!`);
                    } catch (err) {
                        alert('Erro ao ler o arquivo. O JSON é inválido.');
                        console.error(err);
                    }
                };
                reader.readAsText(file);
                // Limpa o input para permitir importar o mesmo arquivo novamente
                event.target.value = null;
            }

            // --- CARREGAR IMAGEM ---
            function loadImage(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imgEl = document.getElementById('characterImage');
                    const uploadTextEl = document.getElementById('uploadText');
                    imgEl.src = e.target.result;
                    imgEl.style.display = 'block';
                    uploadTextEl.style.display = 'none';
                    autoSave();
                };
                reader.readAsDataURL(file);
            }

            // --- CÁLCULOS DE STATS (Apenas HP, Humanidade, etc.) ---
            function getStatValue(statId) {
                const el = document.getElementById(statId);
                return el ? (parseInt(el.value) || 0) : 0;
            }

            function updateAllCalculatedStats() {
                // Calcula PV
                const corpo = getStatValue('CORPO');
                // BTM é o valor arredondado para cima de (CORPO + VON) / 2.
                const btm = Math.ceil((corpo + getStatValue('VON')) / 2);
                const pvMax = 10 + (5 * btm);
                document.getElementById('pv_max').value = pvMax;
                
                // Calcula Gravemente Ferido
                const gfLimiar = Math.ceil(pvMax / 2);
                document.getElementById('gf_limiar').textContent = `(Limiar: ${gfLimiar})`;
                
                // Calcula Teste de Morte
                document.getElementById('teste_morte').value = corpo;
                
                // Calcula Humanidade
                const empBase = getStatValue('EMP_base');
                document.getElementById('humanidade_max').value = empBase * 10;
            }

            // --- RENDERIZAÇÃO DE PERÍCIAS (AGORA COMPLETAMENTE MANUAIS) ---
            function renderAllPericias() {
                for (const categoria in pdfPericias) {
                    const container = document.getElementById(`pericias-${categoria}`);
                    // Limpa perícias antigas, mas mantém o header
                    const header = container.querySelector('.skill-header');
                    container.innerHTML = '';
                    if(header) container.appendChild(header); // Adiciona o header de volta

                    pdfPericias[categoria].forEach(pericia => {
                        const el = createPericiaItem(pericia);
                        container.appendChild(el);
                    });
                }
            }

            function createPericiaItem(pericia) {
                // Cria IDs únicos para cada campo de input
                const baseId = pericia.nome.replace(/[^a-zA-Z0-9]/g, '_').replace(/_+/g, '_');
                const skillIdNvl = baseId + '_nvl';
                const skillIdStat = baseId + '_stat';
                const skillIdBase = baseId + '_base';

                // Pega os valores salvos
                const savedData = getSavedData();
                const nvl = savedData[skillIdNvl] || 0;
                const stat = savedData[skillIdStat] || 0;
                const base = savedData[skillIdBase] || 0;

                const item = document.createElement('div');
                item.className = 'skill-item';
                
                item.innerHTML = `
                    <span class="skill-name">${pericia.nome} <span class="stat-label">(${pericia.stat})</span></span>
                    <input type="number" class="skill-nvl" id="${skillIdNvl}" value="${nvl}" min="0" data-save>
                    <input type="number" class="skill-stat" id="${skillIdStat}" value="${stat}" min="0" data-save>
                    <input type="number" class="skill-base" id="${skillIdBase}" value="${base}" min="0" data-save>
                `;
                
                // Adiciona listeners de autoSave a cada input
                item.querySelectorAll('input').forEach(input => {
                    input.addEventListener('input', autoSave);
                });
                
                return item;
            }

            // --- PERÍCIAS DINÂMICAS (IDIOMAS, ETC.) ---
            function addDynamicSkillRow(type, data = { id: `skill-${type}-${Date.now()}`, nome: '', nvl: 0, stat: 0, base: 0 }) {
                const list = document.getElementById(`${type}-list`);
                const item = document.createElement('div');
                item.className = 'dynamic-skill-item';
                item.dataset.id = data.id;

                const nvl = data.nvl || 0;
                const stat = data.stat || 0;
                const base = data.base || 0;

                item.innerHTML = `
                    <input type="text" class="skill-name-input" placeholder="Nomear ${type}" value="${data.nome}" data-save>
                    <input type="number" class="skill-nvl" value="${nvl}" min="0" data-save>
                    <input type="number" class="skill-stat" value="${stat}" min="0" data-save>
                    <input type="number" class="skill-base" value="${base}" min="0" data-save>
                    <button class="delete-row-btn">X</button>
                `;
                
                // Adiciona listeners de autoSave
                item.querySelectorAll('input').forEach(input => {
                    input.addEventListener('input', autoSave);
                });
                
                item.querySelector('.delete-row-btn').addEventListener('click', () => {
                    item.remove();
                    autoSave();
                });
                
                // Insere o novo item antes do botão de adicionar se ele existir na lista
                const addButton = list.closest('.dynamic-skill-box').querySelector('.add-row-btn');
                if (addButton) {
                    list.insertBefore(item, addButton.nextSibling);
                } else {
                    list.appendChild(item);
                }
            }

            // --- LISTAS DINÂMICAS (ARMAS, EQUIP, CYBER) ---
            
            function addArma(data = { id: `arma-${Date.now()}`, nome: '', dano: '', municao: '', cdt: '', obs: '' }) {
                const list = document.getElementById('armasList');
                const item = document.createElement('div');
                item.className = 'arma-item';
                item.dataset.id = data.id;
                item.innerHTML = `
                    <input type="text" class="arma-nome" placeholder="Nome" value="${data.nome}" data-save>
                    <input type="text" class="arma-dano" placeholder="Dano" value="${data.dano}" data-save>
                    <input type="text" class="arma-municao" placeholder="Munição" value="${data.municao}" data-save>
                    <input type="text" class="arma-cdt" placeholder="CDT" value="${data.cdt}" data-save>
                    <input type="text" class="arma-obs" placeholder="Obs." value="${data.obs}" data-save>
                    <button class="delete-row-btn">X</button>
                `;
                item.querySelectorAll('input').forEach(i => i.addEventListener('input', autoSave));
                item.querySelector('.delete-row-btn').addEventListener('click', () => {
                    item.remove();
                    autoSave();
                });
                list.appendChild(item);
            }

            function addEquipamento(data = { id: `equip-${Date.now()}`, nome: '', qtd: 1, obs: '' }) {
                const list = document.getElementById('equipamentoList');
                const item = document.createElement('div');
                item.className = 'equip-item';
                item.dataset.id = data.id;
                item.innerHTML = `
                    <input type="text" class="equip-nome" placeholder="Nome do Item" value="${data.nome}" data-save>
                    <input type="number" class="equip-qtd" placeholder="Qtd" value="${data.qtd}" min="1" data-save>
                    <input type="text" class="equip-obs" placeholder="Notas" value="${data.obs}" data-save>
                    <button class="delete-row-btn">X</button>
                `;
                item.querySelectorAll('input').forEach(i => i.addEventListener('input', autoSave));
                item.querySelector('.delete-row-btn').addEventListener('click', () => {
                    item.remove();
                    autoSave();
                });
                list.appendChild(item);
            }

            function addCyberItem(type, data = { id: `cyber-${type}-${Date.now()}`, nome: '', info: '' }) {
                const list = document.getElementById(`cyber-${type}-list`);
                const item = document.createElement('li');
                item.className = 'cyber-item';
                item.dataset.id = data.id;
                item.innerHTML = `
                    <input type="text" class="cyber-nome" placeholder="Nome" value="${data.nome}" data-save>
                    <input type="text" class="cyber-info" placeholder="Info/Custo" value="${data.info}" data-save>
                    <button class="delete-row-btn">X</button>
                `;
                item.querySelectorAll('input').forEach(i => i.addEventListener('input', autoSave));
                item.querySelector('.delete-row-btn').addEventListener('click', () => {
                    item.remove();
                    autoSave();
                });
                list.appendChild(item);
            }

            // Inicia a aplicação
            init();
        });
    </script>
</body>
</html>
